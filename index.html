<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å†°å³¶èŠ¬è˜­è‡ªç”±è¡Œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind Play CDN [web:39] -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <style type="text/tailwindcss">
    @theme {
      --color-nordic-bg: #FFF9E6;
      --color-nordic-card: #FFFFFF;
      --color-nordic-accent: #F4D06F;
      --color-nordic-accent-soft: #FAE2A9;
      --color-nordic-text: #2F3A4A;
      --color-nordic-muted: #A0A6B5;
    }
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* å°åœ“æ•¸å­—æ¨£å¼ï¼ˆçµ¦ polyline ä¸Šçš„é †åºæ¨™è¨˜ï¼‰ */
    .route-num {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      border-radius: 9999px;
      background: #f97316;
      color: white;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      border: 2px solid white;
    }
  </style>

  <!-- Vue 3 CDN [web:35] -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <!-- Leaflet åœ°åœ– -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Geoman (leaflet.pm) for editing (optional if you later integrate) -->
  <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.14.0/dist/leaflet-geoman.css" />
  <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.14.0/dist/leaflet-geoman.min.js"></script>
</head>

<body class="bg-[var(--color-nordic-bg)] text-[var(--color-nordic-text)]">
<div id="app" class="min-h-screen flex flex-col max-w-md mx-auto shadow-lg bg-[var(--color-nordic-bg)]">
  <!-- Header -->
  <header class="px-4 pt-4 pb-2 flex items-center justify-between">
    <div>
      <h1 class="text-xl font-semibold tracking-wide">å†°å³¶èŠ¬è˜­è‡ªç”±è¡Œ</h1>
      <p class="text-xs text-[var(--color-nordic-muted)]">å†°å³¶ + èŠ¬è˜­ Â· è¡Œç¨‹ / åœ°åœ– / è²»ç”¨</p>
    </div>
    <div class="flex items-center gap-2">
      <span class="text-xs text-[var(--color-nordic-muted)]">v0.3</span>
    </div>
  </header>

  <!-- æ—¥æœŸæ©«å‘é¸å–® -->
  <section class="px-4 pb-3">
    <div class="flex items-center justify-between mb-1">
      <span class="text-sm font-medium">é¸æ“‡æ—¥æœŸ</span>
      <span class="text-[10px] text-[var(--color-nordic-muted)]">å·¦å³æ»‘å‹•é¸æ“‡è¡Œç¨‹æ—¥</span>
    </div>
    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
      <button
        v-for="(day, index) in days"
        :key="day.id"
        @click="selectDay(index)"
        class="flex-shrink-0 px-3 py-2 rounded-2xl text-xs text-center transition-all duration-150"
        :class="selectedDayIndex === index
          ? 'bg-[var(--color-nordic-accent)] text-[var(--color-nordic-text)] shadow-sm'
          : 'bg-[var(--color-nordic-accent-soft)] text-[var(--color-nordic-muted)]'"
      >
        <div class="font-semibold">{{ day.label }}</div>
        <div class="text-[10px]">{{ day.date }}</div>
        <div class="text-[10px] truncate max-w-[80px]">{{ day.title }}</div>
      </button>
      <!-- æ–°å¢è¡Œç¨‹æŒ‰éˆ•å·²ç§»é™¤ -->
    </div>
  </section>

  <!-- åªä¿ç•™ è¡Œç¨‹ / åœ°åœ– / è²»ç”¨ Tabs -->
  <section class="px-4 pb-2">
    <div class="bg-[var(--color-nordic-card)] rounded-2xl p-1 flex text-xs shadow-sm">
      <button
        v-for="tab in tabs"
        :key="tab"
        @click="currentTab = tab"
        class="flex-1 py-2 rounded-2xl transition-all"
        :class="currentTab === tab
          ? 'bg-[var(--color-nordic-accent)] text-[var(--color-nordic-text)] font-semibold'
          : 'text-[var(--color-nordic-muted)]'"
      >
        {{ tab }}
      </button>
    </div>
  </section>

  <!-- å…§å®¹ -->
  <main class="flex-1 overflow-y-auto px-4 pb-4 space-y-3">
    <!-- è¡Œç¨‹ Tab -->
    <section v-if="currentTab === 'è¡Œç¨‹'">
      <div class="flex items-center justify-between mb-2">
        <div>
          <h2 class="text-sm font-semibold">{{ currentDay.label }} Â· {{ currentDay.title }}</h2>
          <p class="text-[11px] text-[var(--color-nordic-muted)]">{{ currentDay.date }}</p>
        </div>
        <!-- ç§»é™¤æ–°å¢/åˆªé™¤æŒ‰éˆ• -->
      </div>

      <div v-if="currentDay.items.length === 0" class="text-xs text-[var(--color-nordic-muted)] text-center py-8">
        é¸æ“‡å…¶ä»–æ—¥æœŸæŸ¥çœ‹è¡Œç¨‹
      </div>

      <div
        v-for="(item, idx) in currentDay.items"
        :key="item.id"
        class="bg-[var(--color-nordic-card)] rounded-2xl p-3 shadow-sm mb-2"
      >
        <div class="flex items-center justify-between mb-1">
          <div class="flex items-center gap-2">
            <div class="text-xs font-semibold px-2 py-1 bg-[var(--color-nordic-accent-soft)] rounded-xl">
              {{ item.time }}
            </div>
            <span class="text-[10px] text-[var(--color-nordic-muted)]">
              {{ item.type || 'è¡Œç¨‹' }}
            </span>
          </div>
        </div>

        <div class="text-xs font-medium mb-1">{{ item.place }}</div>

        <div v-if="item.note" class="text-[11px] text-[var(--color-nordic-muted)] leading-relaxed mb-2">
          {{ item.note }}
        </div>

        <!-- å¤©æ°£è³‡è¨Š -->
        <div class="mt-2 flex items-center justify-between text-[11px] text-[var(--color-nordic-muted)]">
          <div class="flex items-center gap-1">
            <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-[var(--color-nordic-accent-soft)]">
              ğŸŒ¤
            </span>
            <span v-if="item.weather && !item.weather.loading">
              {{ item.weather.temp }}Â°C Â· {{ item.weather.summary }}
            </span>
            <span v-else-if="item.weather && item.weather.loading">
              è®€å–å¤©æ°£ä¸­â€¦
            </span>
            <span v-else>
              é»æ“Šå–å¾—å¤©æ°£
            </span>
          </div>
          <button
            @click="fetchWeatherForItem(item)"
            class="text-[10px] underline decoration-dotted hover:text-[var(--color-nordic-text)] transition-colors"
          >
            å¤©æ°£
          </button>
        </div>
      </div>
    </section>

    <!-- åœ°åœ– Tabï¼ˆv-show ä¿ç•™å®¹å™¨ï¼‰ -->
    <section v-show="currentTab === 'åœ°åœ–'">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-sm font-semibold">åœ°åœ–èˆ‡å°èˆª</h2>
        <div class="flex items-center gap-2">
          <button
            @click="focusTodayOnMap"
            class="text-[10px] px-2 py-1 rounded-xl bg-[var(--color-nordic-accent)]"
          >
            é‡æ–°æ•´ç†é‡˜é»
          </button>
          <button
            @click="toggleRoute"
            :class="showRoute ? 'bg-[var(--color-nordic-text)] text-white' : 'bg-[var(--color-nordic-accent-soft)] text-[var(--color-nordic-text)]'"
            class="text-[10px] px-2 py-1 rounded-xl border"
          >
            {{ showRoute ? 'éš±è—è·¯ç·š' : 'é¡¯ç¤ºè·¯ç·šé †åº' }}
          </button>
        </div>
      </div>

      <div class="text-[11px] text-[var(--color-nordic-muted)] mb-1">
        æœƒå°‡ç•¶æ—¥æ‰€æœ‰è¡Œç¨‹åœ°é»é‡˜åœ¨åœ°åœ–ä¸Šï¼Œä¸¦å¯é¡¯ç¤ºä¾è¡Œç¨‹é †åºçš„è·¯ç·šï¼ˆæŠ˜ç·šèˆ‡é †åºæ•¸å­—ï¼‰ã€‚
      </div>

      <div id="map" class="w-full h-64 rounded-2xl overflow-hidden shadow-sm"></div>
    </section>

    <!-- è²»ç”¨ Tab -->
    <section v-if="currentTab === 'è²»ç”¨'">
      <div class="flex items-center justify-between mb-2">
        <div>
          <h2 class="text-sm font-semibold">{{ currentDay.label }} Â· è²»ç”¨ç´€éŒ„</h2>
          <p class="text-[11px] text-[var(--color-nordic-muted)]">{{ currentDay.date }} â€” å¯è¨˜éŒ„ä¸¦åˆ†é¡å€‹äººè²»ç”¨</p>
        </div>
        <div class="text-[11px] text-[var(--color-nordic-muted)]">
          äººæ•¸
          <input type="number" v-model.number="numberOfPeople" min="1" class="w-14 ml-2 px-2 py-1 text-[11px] rounded-xl border" />
        </div>
      </div>

      <div class="mb-2 text-[11px] text-[var(--color-nordic-muted)]">
        æ–°å¢è²»ç”¨é …ç›®ï¼Œé‡‘é¡ç‚ºã€Œæ¯äººé‡‘é¡ã€ï¼Œç³»çµ±æœƒé¡¯ç¤ºæ¯äººå°è¨ˆèˆ‡ä¹˜ä¸Šç¸½äººæ•¸å¾Œçš„ç¸½è¨ˆã€‚
      </div>

      <div class="bg-[var(--color-nordic-card)] rounded-2xl p-3 shadow-sm mb-3">
        <!-- æ–°å¢è²»ç”¨è¡¨å–® -->
        <div class="flex gap-2 mb-2">
          <select v-model="newExpense.category" class="px-2 py-1 rounded-xl text-[11px] border">
            <option>æ™¯é»</option>
            <option>ä½å®¿</option>
            <option>é¤é£Ÿ</option>
            <option>å…¶ä»–</option>
          </select>
          <input v-model="newExpense.desc" placeholder="èªªæ˜ (ä¾‹å¦‚ï¼šé–€ç¥¨ / æ™šé¤)" class="flex-1 px-2 py-1 rounded-xl text-[11px] border" />
          <input v-model.number="newExpense.amount" type="number" min="0" step="0.01" placeholder="æ¯äººé‡‘é¡" class="w-28 px-2 py-1 rounded-xl text-[11px] border" />
          <button @click="addExpense(currentDay)" class="px-3 py-1 rounded-xl bg-[var(--color-nordic-accent)] text-[var(--color-nordic-text)] text-[11px]">æ–°å¢</button>
        </div>

        <!-- ç•¶æ—¥è²»ç”¨åˆ—è¡¨ -->
        <div v-if="currentDay.expenses && currentDay.expenses.length === 0" class="text-[11px] text-[var(--color-nordic-muted)] py-6 text-center">
          å°šç„¡è²»ç”¨ç´€éŒ„ï¼Œä½¿ç”¨ä¸Šæ–¹è¡¨å–®æ–°å¢ã€‚
        </div>

        <div v-for="expense in currentDay.expenses" :key="expense.id" class="border-t pt-2 mt-2 text-[12px]">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <select v-model="expense.category" class="px-2 py-1 rounded-xl text-[11px] border">
                <option>æ™¯é»</option>
                <option>ä½å®¿</option>
                <option>é¤é£Ÿ</option>
                <option>å…¶ä»–</option>
              </select>
              <input v-model="expense.desc" placeholder="èªªæ˜" class="px-2 py-1 rounded-xl text-[11px] border" />
            </div>
            <div class="flex items-center gap-2">
              <div class="text-[11px] text-[var(--color-nordic-muted)]">æ¯äºº</div>
              <input v-model.number="expense.amount" type="number" min="0" step="0.01" class="w-24 px-2 py-1 rounded-xl text-[11px] border" />
              <button @click="removeExpense(currentDay, expense.id)" class="text-[11px] px-2 py-1 rounded-xl bg-red-100 text-red-600">åˆªé™¤</button>
            </div>
          </div>
          <div class="text-[11px] text-[var(--color-nordic-muted)] mt-1">
            ç¸½è¨ˆï¼šæ¯äºº {{ formatCurrency(expense.amount) }} Ã— {{ numberOfPeople }} = <strong>{{ formatCurrency(expense.amount * numberOfPeople) }}</strong>
          </div>
        </div>

        <!-- ç•¶æ—¥åˆ†é¡å°è¨ˆ -->
        <div class="mt-3 border-t pt-3">
          <div class="flex items-center justify-between text-[12px] mb-1">
            <div class="text-[13px] font-medium">ç•¶æ—¥å°è¨ˆ</div>
            <div class="text-[12px] text-[var(--color-nordic-muted)]">æ¯äºº / ç¸½è¨ˆ</div>
          </div>

          <div v-for="(vals, cat) in dayCategoryTotals(currentDay)" :key="cat" class="flex items-center justify-between text-[12px] py-1">
            <div class="text-[11px] text-[var(--color-nordic-muted)]">{{ cat }}</div>
            <div class="text-[12px]">
              {{ formatCurrency(vals.perPerson) }} / <strong>{{ formatCurrency(vals.total) }}</strong>
            </div>
          </div>

          <div class="flex items-center justify-between text-[13px] font-semibold mt-2">
            <div>ç•¶æ—¥åˆè¨ˆ</div>
            <div>
              {{ formatCurrency(dayTotalPerPerson(currentDay)) }} / <strong>{{ formatCurrency(dayTotalAll(currentDay)) }}</strong>
            </div>
          </div>
        </div>
      </div>

      <!-- å…¨éƒ¨æ—¥æœŸç¸½è¦½ -->
      <div class="bg-[var(--color-nordic-card)] rounded-2xl p-3 shadow-sm">
        <div class="flex items-center justify-between mb-2">
          <div class="text-[13px] font-semibold">å…¨éƒ¨æ—¥æœŸç¸½è¨ˆ</div>
        </div>

        <div class="text-[12px]">
          <div class="flex items-center justify-between py-1">
            <div class="text-[11px] text-[var(--color-nordic-muted)]">ç¸½äººå‡èŠ±è²»</div>
            <div class="text-[13px] font-semibold">{{ formatCurrency(totalPerPersonAcrossDays) }}</div>
          </div>

          <div class="flex items-center justify-between py-1">
            <div class="text-[11px] text-[var(--color-nordic-muted)]">ç¸½åˆè¨ˆï¼ˆæ‰€æœ‰äººï¼‰</div>
            <div class="text-[13px] font-semibold">{{ formatCurrency(totalAllPeopleAcrossDays) }}</div>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      // æ–°å¢ è²»ç”¨ tab
      tabs: ['è¡Œç¨‹', 'åœ°åœ–', 'è²»ç”¨'],
      currentTab: 'è¡Œç¨‹',

      // å·²é å¡ 2/24â€“3/8 å†°å³¶ + èŠ¬è˜­è¡Œç¨‹ï¼ˆä¸å¯ç·¨è¼¯ï¼‰
      days: [
        {
          id: 1,
          label: 'Day 1',
          date: '02/24',
          title: 'å°åŒ— â†’ å†°å³¶ï¼ˆè½‰æ©Ÿï¼šä»å·ã€èµ«çˆ¾è¾›åŸºï¼‰',
          items: [
            {
              id: 101,
              time: '14:00â€“14:40',
              place: 'æ¿æ©‹ â†’ æ¡ƒåœ’æ©Ÿå ´',
              type: 'æ©Ÿå ´æ¥é€',
              note: 'æ©Ÿå ´æ¥é€æœå‹™ï¼ˆå»ºè­°é ç•™ç·©è¡æ™‚é–“ä»¥å…è¶•ä¸ä¸Šæ«ƒæª¯èˆ‡å®‰æª¢ï¼‰ã€‚',
              lat: 25.0803,
              lng: 121.2327,
              weather: null,
            },
            {
              id: 102,
              time: '17:10â€“20:35',
              place: 'å°åŒ—æ¡ƒåœ’ (TPE) â†’ ä»å·åœ‹éš›æ©Ÿå ´ (ICN)',
              type: 'èˆªç­ï¼ˆOZ714ï¼‰',
              note: 'éŸ“äºèˆªç©º OZ714ã€‚å‡ºç™¼ 17:10ï¼ˆTPEï¼‰ï¼ŒæŠµé” 20:35ï¼ˆICNï¼‰ã€‚',
              lat: 25.0803,
              lng: 121.2327,
              weather: null,
            },
            {
              id: 103,
              time: '20:35â€“23:00',
              place: 'ä»å·åœ‹éš›æ©Ÿå ´ â€” è½‰æ©Ÿç­‰å¾…',
              type: 'è½‰æ©Ÿ',
              note: 'è½‰æ©Ÿæ™‚é–“ç´„ 2 å°æ™‚ 25 åˆ†é˜ï¼Œç¢ºèªç™»æ©Ÿé–€èˆ‡æ˜¯å¦éœ€å†æ¬¡å®‰æª¢ï¼å‡ºå¢ƒæ‰‹çºŒã€‚',
              lat: 37.4602,
              lng: 126.4407,
              weather: null,
            },
            {
              id: 104,
              time: '23:00â€“05:40 (+1)',
              place: 'ä»å· (ICN) â†’ èµ«çˆ¾è¾›åŸº (HEL)',
              type: 'èˆªç­ï¼ˆAY42ï¼‰',
              note: 'èŠ¬è˜­èˆªç©º AY42ã€‚é•·ç¨‹èˆªç­ï¼Œæ©Ÿä¸Šæœ‰é¤é£²èˆ‡å¨›æ¨‚ï¼ŒæŠµé” HEL å¾ŒçŸ­æš«è½‰æ©Ÿï¼ˆç´„ 1 å°æ™‚ 25 åˆ†ï¼‰ã€‚',
              lat: 37.4602,
              lng: 126.4407,
              weather: null,
            },
            {
              id: 105,
              time: '05:40â€“07:05',
              place: 'èµ«çˆ¾è¾›åŸºæ©Ÿå ´ â€” è½‰æ©Ÿç­‰å¾…',
              type: 'è½‰æ©Ÿ',
              note: 'è½‰æ©Ÿæ™‚é–“ç´„ 1 å°æ™‚ 25 åˆ†é˜ï¼Œè«‹ç¢ºèªç™»æ©Ÿé–€èˆ‡è¡Œææ˜¯å¦ç›´æ›ã€‚',
              lat: 60.3172,
              lng: 24.9633,
              weather: null,
            },
            {
              id: 106,
              time: '07:05â€“09:00',
              place: 'èµ«çˆ¾è¾›åŸº (HEL) â†’ å‡±å¤«æ‹‰ç¶­å…‹ / é›·å…‹é›…æœªå…‹ (KEF)',
              type: 'èˆªç­ï¼ˆAY995ï¼‰',
              note: 'èŠ¬è˜­èˆªç©º AY995ã€‚æŠµé” KEF å¾Œå…¥å¢ƒã€é ˜è¡Œæä¸¦å‰å¾€å¸‚å€é£¯åº—æˆ–æ¥é§é»ã€‚',
              lat: 63.985,
              lng: -22.6056,
              weather: null,
            },
          ],
        },
        {
          id: 2,
          label: 'Day 2',
          date: '02/25',
          title: 'æŠµé”é›·å…‹é›…æœªå…‹',
          items: [
            {
              id: 201,
              time: '09:00â€“12:00',
              place: 'å‡±å¤«æ‹‰ç¶­å…‹æ©Ÿå ´ â†’ é›·å…‹é›…æœªå…‹é£¯åº—',
              type: 'äº¤é€š',
              note: 'æŠµé”å†°å³¶å¾Œå…¥å¢ƒã€é ˜è¡Œæï¼Œæ­å·´å£«æˆ–æ¥é§å‰å¾€å¸‚å€é£¯åº—ï¼Œå…ˆå¯„æ”¾è¡Œæã€‚',
              lat: 63.985,
              lng: -22.6056,
              weather: null,
            },
            {
              id: 202,
              time: '12:00â€“16:00',
              place: 'é›·å…‹é›…æœªå…‹å¸‚å€æ•£æ­¥',
              type: 'å¸‚å€',
              note: 'å»ºè­°è·¯ç·šï¼šå“ˆçˆ¾æ ¼æ—å§†æ•™å ‚ã€å¤ªé™½èˆªæµ·è€…é›•åƒã€èˆŠæ¸¯å€ã€Laugavegur é€›è¡—ã€‚',
              lat: 64.1466,
              lng: -21.9426,
              weather: null,
            },
            {
              id: 203,
              time: '16:00â€“16:30',
              place: 'é£¯åº— Check-in',
              type: 'ä½å®¿',
              note: 'è¾¦ç†å…¥ä½ã€ç¨ä½œä¼‘æ¯ã€‚',
              lat: 64.1466,
              lng: -21.9426,
              weather: null,
            },
            {
              id: 204,
              time: '17:00â€“18:30',
              place: 'æ™šé¤',
              type: 'é¤é£Ÿ',
              note: 'å¯ä»¥æ‰¾å¸‚å€é¤å»³æˆ–è¶…å¸‚ç°¡å–®åƒï¼Œé †ä¾¿è²·éš”å¤©è»Šç¨‹å°é»å¿ƒã€‚',
              lat: 64.1466,
              lng: -21.9426,
              weather: null,
            },
          ],
        },
        {
          id: 3,
          label: 'Day 3',
          date: '02/26',
          title: 'æ–¯å¥ˆå±±åŠå³¶ä¸€æ—¥éŠ',
          items: [
            {
              id: 301,
              time: '08:00â€“08:30',
              place: 'é£¯åº—é–€å£æ¥é§',
              type: 'é›†åˆ',
              note: 'ç­‰å¾…æ–¯å¥ˆå±±åŠå³¶ä¸€æ—¥éŠå°ˆè»Šæ¥é€ï¼Œç¢ºèªå‡ºç™¼é»èˆ‡è¯çµ¡æ–¹å¼ã€‚',
              lat: 64.1466,
              lng: -21.9426,
              weather: null,
            },
            {
              id: 302,
              time: '08:30â€“20:00',
              place: 'æ–¯å¥ˆå±±åŠå³¶ä¸€æ—¥éŠ',
              type: 'è¡Œç¨‹',
              note: 'å…¸å‹æ™¯é»ï¼šæ•™æœƒå±±ã€é»‘æ²™ç˜ã€æ¼æ‘å°é®ç­‰ï¼Œä¾å¯¦éš›åœ˜é«”è·¯ç·šç‚ºæº–ã€‚[web:8]',
              lat: 64.9,
              lng: -23.7,
              weather: null,
            },
          ],
        },
        {
          id: 4,
          label: 'Day 4',
          date: '02/27',
          title: 'å—éƒ¨ä¸‰æ—¥éŠ Day 1ï¼ˆé»ƒé‡‘åœˆï¼‹è—æ¹–ï¼‰',
          items: [
            {
              id: 401,
              time: '08:00â€“08:30',
              place: 'é£¯åº—æ¥é§å‡ºç™¼',
              type: 'é›†åˆ',
              note: 'é–‹å§‹å—éƒ¨ä¸‰æ—¥éŠï¼Œæº–å‚™å¥½è¡Œæï¼Œå¸¶é½Šä¿æš–è¡£ç‰©èˆ‡ç›¸æ©Ÿã€‚[web:5]',
              lat: 64.1466,
              lng: -21.9426,
              weather: null,
            },
            {
              id: 402,
              time: 'ä¸Šåˆ',
              place: 'è¾›æ ¼ç¶­åˆ©çˆ¾åœ‹å®¶å…¬åœ’',
              type: 'æ™¯é»',
              note: 'ä¸–ç•Œéºç”¢åœ°é»ï¼Œæ¿å¡Šè£‚ç¸«æ™¯è§€ï¼Œå¯ç°¡å–®æ­¥é“æ•£æ­¥æ‹ç…§ã€‚[web:3]',
              lat: 64.255,
              lng: -21.129,
              weather: null,
            },
            {
              id: 403,
              time: 'ä¸­åˆå‰å¾Œ',
              place: 'è“‹æ­‡çˆ¾åœ°ç†±å€ï¼ˆGeysirï¼Strokkurï¼‰',
              type: 'æ™¯é»',
              note: 'è§€è³ Strokkur é–“æ­‡æ³‰å™´ç™¼ï¼Œè¨˜å¾—æ³¨æ„é¢¨å¹å‘é¿å…è¢«æ°´å™´åˆ°ã€‚[web:3]',
              lat: 64.3104,
              lng: -20.3024,
              weather: null,
            },
            {
              id: 404,
              time: 'ä¸‹åˆ',
              place: 'é»ƒé‡‘ç€‘å¸ƒï¼ˆGullfossï¼‰',
              type: 'æ™¯é»',
              note: 'è‘—åå¤§ç€‘å¸ƒï¼Œå†¬å¤©è·¯é¢å¯èƒ½çµå†°ï¼Œèµ°è·¯è¦å°å¿ƒã€‚[web:3]',
              lat: 64.3275,
              lng: -20.1218,
              weather: null,
            },
            {
              id: 405,
              time: 'å‚æ™šï½æ™šä¸Š',
              place: 'è—æ¹–æº«æ³‰',
              type: 'æº«æ³‰',
              note: 'é ç´„æ™‚æ®µç‚ºæº–ï¼Œè¨˜å¾—å¸¶æ³³è¡£èˆ‡é˜²æ°´åŒ…ã€‚æ³¡å®Œç›´æ¥é€å¾€ä½å®¿é£¯åº—ã€‚[web:1]',
              lat: 63.8804,
              lng: -22.4495,
              weather: null,
            },
          ],
        },
        {
          id: 5,
          label: 'Day 5',
          date: '02/28',
          title: 'å—éƒ¨ä¸‰æ—¥éŠ Day 2ï¼ˆç€‘å¸ƒï¼‹å†°å·ï¼‰',
          items: [
            {
              id: 501,
              time: 'æ—©ä¸Š',
              place: 'å¡é‡Œé›…è˜­ç€‘å¸ƒï¼ˆSeljalandsfossï¼‰',
              type: 'æ™¯é»',
              note: 'å¯ä»¥èµ°åˆ°ç€‘å¸ƒå¾Œæ–¹çš„ç¶“å…¸é»ï¼Œä½†å†¬å¤©åœ°é¢æ¿•æ»‘ï¼Œé›ªåœ°é‹å¾ˆé‡è¦ã€‚[web:3]',
              lat: 63.6156,
              lng: -19.9928,
              weather: null,
            },
            {
              id: 502,
              time: 'ä¸Šåˆï½ä¸­åˆ',
              place: 'æ–¯ç§‘åŠ ç€‘å¸ƒï¼ˆSkÃ³gafossï¼‰',
              type: 'æ™¯é»',
              note: 'å¯ä»¥èµ°æ¨“æ¢¯åˆ°ä¸Šæ–¹è§€æ™¯å°ï¼Œå¤©æ°£å¥½æ™‚å¸¸æœ‰å½©è™¹ã€‚[web:3]',
              lat: 63.5321,
              lng: -19.511,
              weather: null,
            },
            {
              id: 503,
              time: 'ä¸‹åˆ',
              place: 'ç´¢çˆ¾é»‘é¦¬å†°å·æˆ–æ–¯å¡å¤«å¡”å†°å·å¥è¡Œ',
              type: 'æ´»å‹•',
              note: 'ä¾ä½ é è¨‚çš„åœ˜æ±ºå®šå†°å·åœ°é»ï¼Œè¨˜å¾—æ‰‹å¥—ã€å¸½å­ã€ä¿æš–å±¤èˆ‡ç›¸æ©Ÿé›»æ± å‚™ä»½ã€‚[web:4]',
              lat: 63.530,
              lng: -19.363,
              weather: null,
            },
          ],
        },
        {
          id: 6,
          label: 'Day 6',
          date: '03/01',
          title: 'å—éƒ¨ä¸‰æ—¥éŠ Day 3ï¼ˆå†°æ²³æ¹–ï¼‹è—å†°æ´ï¼‰',
          items: [
            {
              id: 601,
              time: 'æ—©ä¸Š',
              place: 'å‚‘å¤æ²™é¾å†°æ²³æ¹–ï¼ˆJÃ¶kulsÃ¡rlÃ³nï¼‰',
              type: 'æ™¯é»',
              note: 'æ¬£è³æ¼‚æµ®å†°å±±èˆ‡å¯èƒ½å‡ºç¾çš„æµ·è±¹ï¼Œæ³¨æ„ä¿æš–èˆ‡é˜²é¢¨ã€‚[web:4]',
              lat: 64.048,
              lng: -16.179,
              weather: null,
            },
            {
              id: 602,
              time: 'æ—©ä¸Šï½ä¸­åˆ',
              place: 'é‘½çŸ³æ²™ç˜ï¼ˆDiamond Beachï¼‰',
              type: 'æ™¯é»',
              note: 'é»‘æ²™ç˜ä¸Šæ•£è½é€æ˜å†°å¡Šï¼Œå¾ˆé©åˆæ‹ç…§ï¼Œå°å¿ƒå¤§æµªã€‚[web:4]',
              lat: 64.044,
              lng: -16.181,
              weather: null,
            },
            {
              id: 603,
              time: 'ä¸­åˆï½ä¸‹åˆ',
              place: 'è—å†°æ´æ¢éšª',
              type: 'æ´»å‹•',
              note: 'è·Ÿéš¨å°éŠé€²å…¥å†°æ´ï¼Œé¿å…è‡ªè¡Œèµ°å‹•ï¼Œä¾å¤©å€™èª¿æ•´æ˜¯å¦èƒ½æˆè¡Œã€‚[web:11]',
              lat: 64.05,
              lng: -16.2,
              weather: null,
            },
            {
              id: 604,
              time: 'ä¸‹åˆ',
              place: 'é›·å°¼æ–¯é»‘æ²™ç˜ï¼ˆReynisfjaraï¼‰',
              type: 'æ™¯é»',
              note: 'å¤©ç©ºä¹‹é¡é»‘æ²™ç˜ï¼Œæ³¨æ„ã€Œå·è¥²æµ·æµªã€ï¼Œä¸è¦å¤ªé è¿‘æµ·é‚Šã€‚[web:20]',
              lat: 63.404,
              lng: -19.045,
              weather: null,
            },
          ],
        },
        {
          id: 7,
          label: 'Day 7',
          date: '03/02',
          title: 'å†°å³¶ â†’ ç¾…ç“¦æ¶…ç±³',
          items: [
            {
              id: 701,
              time: '07:30',
              place: 'å‰å¾€å‡±å¤«æ‹‰ç¶­å…‹æ©Ÿå ´',
              type: 'äº¤é€š',
              note: 'å»ºè­°ææ—©åˆ°æ©Ÿå ´è¾¦ç†é€€ç¨…èˆ‡è¨—é‹ã€‚',
              lat: 63.985,
              lng: -22.6056,
              weather: null,
            },
            {
              id: 702,
              time: '10:00â€“15:25',
              place: 'å†°å³¶ â†’ èµ«çˆ¾è¾›åŸºï¼ˆHELï¼‰',
              type: 'èˆªç­',
              note: 'é•·ç¨‹èˆªç­ï¼Œç¢ºèªè½‰æ©Ÿæ™‚é–“èˆ‡ç™»æ©Ÿé–€ã€‚',
              lat: 60.3172,
              lng: 24.9633,
              weather: null,
            },
            {
              id: 703,
              time: '19:40â€“21:05',
              place: 'èµ«çˆ¾è¾›åŸº â†’ ç¾…ç“¦æ¶…ç±³ï¼ˆRVNï¼‰',
              type: 'èˆªç­',
              note: 'æ™šé–“åœ‹å…§ç·šï¼Œæ³¨æ„è¡Œææ˜¯å¦ç›´æ›ã€‚',
              lat: 66.5648,
              lng: 25.8304,
              weather: null,
            },
          ],
        },
        {
          id: 8,
          label: 'Day 8',
          date: '03/03',
          title: 'ç¾…ç“¦æ¶…ç±³å¸‚å€ï¼‹è–èª•è€äººæ‘',
          items: [
            {
              id: 801,
              time: 'ä¸Šåˆ',
              place: 'ç¾…ç“¦æ¶…ç±³å¸‚å€ï¼å‹•ç‰©åœ’ï¼åšç‰©é¤¨',
              type: 'è‡ªç”±è¡Œç¨‹',
              note: 'å¯è€ƒæ…® Arktikum åŒ—æ¥µåšç‰©é¤¨æˆ–ç•¶åœ°å‹•ç‰©åœ’ï¼Œä¾ç¾å ´å®‰æ’ã€‚[web:18]',
              lat: 66.5039,
              lng: 25.7294,
              weather: null,
            },
            {
              id: 802,
              time: 'ä¸‹åˆ',
              place: 'å‰å¾€è–èª•è€äººæ‘',
              type: 'äº¤é€š',
              note: 'æ­å·´å£«æˆ–æ¥é§å‰å¾€ç´„ 8 å…¬é‡Œå¤–çš„è–èª•è€äººæ‘ã€‚[web:15]',
              lat: 66.5432,
              lng: 25.8472,
              weather: null,
            },
            {
              id: 803,
              time: 'ä¸‹åˆï½æ™šä¸Š',
              place: 'è–èª•è€äººæ‘ Check-in + é€›æ‘èŠ',
              type: 'ä½å®¿',
              note: 'æ‹ç…§ã€è·¨åŒ—æ¥µåœˆã€é€›éƒµå±€èˆ‡ç´€å¿µå“åº—ã€‚',
              lat: 66.5432,
              lng: 25.8472,
              weather: null,
            },
          ],
        },
        {
          id: 9,
          label: 'Day 9',
          date: '03/04',
          title: 'åŒ—æ¥µæ£®æ—æ¢éšªï¼‹æ¥µå…‰è¿½å°‹',
          items: [
            {
              id: 901,
              time: '10:00â€“14:00',
              place: 'åŒ—æ¥µæ£®æ—æ¢éšªï¼ˆå«çƒ¤è‚‰åˆé¤ï¼‰',
              type: 'æ´»å‹•',
              note: 'ä¾è¡Œç¨‹å…§å®¹å¯èƒ½åŒ…å«é›ªé‹ã€é›ªåœ°å¥è¡Œæˆ–é›ªåœ°æ‘©æ‰˜ï¼Œæ³¨æ„ä¿æš–èˆ‡æ‰‹è…³é˜²å‡ã€‚[web:18]',
              lat: 66.5,
              lng: 25.8,
              weather: null,
            },
            {
              id: 902,
              time: '20:00â€“23:00',
              place: 'æ¥µå…‰è¿½å°‹ä¹‹æ—…ï¼ˆå«çƒ¤è‚‰æ™šé¤ï¼‰',
              type: 'æ´»å‹•',
              note: 'å·´å£«æˆ–å°åœ˜å‰å¾€å…‰å®³è¼ƒå°‘åœ°é»è¿½æ¥µå…‰ï¼Œè¨˜å¾—å¸¶è…³æ¶èˆ‡å‚™ç”¨é›»æ± ã€‚[web:6][web:9]',
              lat: 66.7,
              lng: 25.9,
              weather: null,
            },
          ],
        },
        {
          id: 10,
          label: 'Day 10',
          date: '03/05',
          title: 'è–èª•è€äººæ‘æ´»å‹•ï¼‹å¤œèˆ–ç«è»Š',
          items: [
            {
              id: 1001,
              time: '09:00â€“14:00',
              place: 'è–èª•è€äººæ‘ã€å“ˆå£«å¥‡èˆ‡é¦´é¹¿æ¢éšª',
              type: 'æ´»å‹•',
              note: 'å“ˆå£«å¥‡ï¼é¦´é¹¿é›ªæ©‡é«”é©—ï¼‹è–èª•è€äººæ‘æ´»å‹•ï¼Œæ³¨æ„å®‰å…¨åŠä¿æš–ã€‚[web:18]',
              lat: 66.5432,
              lng: 25.8472,
              weather: null,
            },
            {
              id: 1002,
              time: '14:00â€“16:00',
              place: 'è–èª•è€äººæ‘è‡ªç”±æ´»å‹•',
              type: 'è‡ªç”±è¡Œç¨‹',
              note: 'è£œæ‹ç…§ã€è²·ç´€å¿µå“ã€å¯„åŒ—æ¥µåœˆéƒµæˆ³æ˜ä¿¡ç‰‡ã€‚[web:15]',
              lat: 66.5432,
              lng: 25.8472,
              weather: null,
            },
            {
              id: 1003,
              time: '21:00â€“ç¿Œæ—¥',
              place: 'VR æ¥µåœ°å¤œèˆ–åˆ—è»Šï¼ˆä¸Šèˆ–ï¼‰',
              type: 'äº¤é€š',
              note: 'æ­å¤œè»Šå‰å¾€èµ«çˆ¾è¾›åŸºï¼Œåˆ—è»Šä¸Šå¯ç°¡å–®ç›¥æ´—èˆ‡ä¼‘æ¯ã€‚[web:16]',
              lat: 65.5,
              lng: 25,
              weather: null,
            },
          ],
        },
        {
          id: 11,
          label: 'Day 11',
          date: '03/06',
          title: 'èµ«çˆ¾è¾›åŸºï¼‹åš•åš•ç±³åšç‰©é¤¨',
          items: [
            {
              id: 1101,
              time: '09:15',
              place: 'æŠµé”èµ«çˆ¾è¾›åŸºè»Šç«™',
              type: 'äº¤é€š',
              note: 'ä¸‹è»Šå¾Œå…ˆæ‰¾ç½®ç‰©æ«ƒæˆ–å‰å¾€é£¯åº—å¯„æ”¾è¡Œæã€‚',
              lat: 60.1719,
              lng: 24.9414,
              weather: null,
            },
            {
              id: 1102,
              time: '10:00â€“15:00',
              place: 'èµ«çˆ¾è¾›åŸº â†” å¦ä½©é›· Â· åš•åš•ç±³åšç‰©é¤¨',
              type: 'è¡Œç¨‹',
              note: 'æ­ VR ç«è»Šå¾€å¦ä½©é›·ï¼Œåƒè§€ Moomin Museum å¾Œå†æ­è»Šè¿”å›ã€‚[web:7][web:16]',
              lat: 61.4981,
              lng: 23.7608,
              weather: null,
            },
          ],
        },
        {
          id: 12,
          label: 'Day 12',
          date: '03/07',
          title: 'èµ«çˆ¾è¾›åŸºå¸‚å€ï¼‹è¿”å°',
          items: [
            {
              id: 1201,
              time: '11:00â€“13:00',
              place: 'åˆé¤',
              type: 'é¤é£Ÿ',
              note: 'æ‰¾å¸‚ä¸­å¿ƒé¤å»³äº«ç”¨åˆé¤ï¼Œé †è·¯å®‰æ’ä¸‹ä¸€ç«™æ™¯é»ã€‚',
              lat: 60.1719,
              lng: 24.9414,
              weather: null,
            },
            {
              id: 1202,
              time: '13:00â€“18:00',
              place: 'èµ«çˆ¾è¾›åŸºå¸‚å€è§€å…‰',
              type: 'å¸‚å€',
              note: 'å»ºè­°ï¼šèµ«çˆ¾è¾›åŸºå¤§æ•™å ‚ã€å¸‚å ´å»£å ´ã€å²©çŸ³æ•™å ‚ç­‰ã€‚[web:19]',
              lat: 60.1719,
              lng: 24.9414,
              weather: null,
            },
            {
              id: 1203,
              time: '20:30â€“21:30',
              place: 'å¸‚ä¸­å¿ƒ â†’ HEL æ©Ÿå ´',
              type: 'äº¤é€š',
              note: 'æ­æ©Ÿå ´ç«è»Šç´„ 30 åˆ†é˜ï¼Œé ç•™ç­‰è»Šæ™‚é–“ã€‚[web:19]',
              lat: 60.3172,
              lng: 24.9633,
              weather: null,
            },
          ],
        },
        {
          id: 13,
          label: 'Day 13',
          date: '03/08',
          title: 'æŠµé”å°åŒ—',
          items: [
            // å›ç¨‹èˆªç­ï¼šHEL -> HKG (AY99) 00:50â€“19:05
            {
              id: 1301,
              time: '00:50â€“19:05',
              place: 'èµ«çˆ¾è¾›åŸºæ©Ÿå ´ (HEL) â†’ é¦™æ¸¯ (HKG)',
              type: 'èˆªç­ï¼ˆèŠ¬è˜­èˆªç©º AY99ï¼‰',
              note: 'å‡ºç™¼ 00:50ï¼ˆHELï¼‰ï¼Œé£›è¡Œç´„ 12 å°æ™‚ 15 åˆ†é˜ï¼Œ19:05 æŠµé”é¦™æ¸¯ï¼Œæ–¼é¦™æ¸¯æ©Ÿå ´è½‰æ©Ÿç´„ 2 å°æ™‚ 05 åˆ†ï¼ˆè¦‹ä¸‹ä¸€æ®µï¼‰ã€‚èˆªç­æœå‹™ã€é¤é£Ÿèˆ‡æ©Ÿä¸Šå¨›æ¨‚è«‹åƒè€ƒèˆªç©ºå…¬å‘Šã€‚',
              lat: 60.3172,
              lng: 24.9633,
              weather: null,
            },
            // è½‰æ©Ÿç­‰å¾…ï¼šHKG 19:05â€“21:10
            {
              id: 1302,
              time: '19:05â€“21:10',
              place: 'é¦™æ¸¯æ©Ÿå ´ â€” è½‰æ©Ÿç­‰å¾…ï¼ˆç´„ 2 å°æ™‚ 05 åˆ†é˜ï¼‰',
              type: 'è½‰æ©Ÿ',
              note: 'å»ºè­°ç¢ºèªç™»æ©Ÿé–€èˆ‡æ˜¯å¦éœ€é€šé—œæˆ–é‡æ–°å®‰æª¢ï¼Œé ç•™æ™‚é–“è™•ç†ç™»æ©Ÿèˆ‡å…ç¨…åº—äº‹å®œã€‚',
              lat: 22.3080,
              lng: 113.9185,
              weather: null,
            },
            // è½‰æ©Ÿèˆªç­ï¼šHKG -> TPE (BR858) 21:10â€“22:55
            {
              id: 1303,
              time: '21:10â€“22:55',
              place: 'é¦™æ¸¯ (HKG) â†’ å°åŒ—æ¡ƒåœ’ (TPE)',
              type: 'èˆªç­ï¼ˆé•·æ¦®èˆªç©º BR858ï¼‰',
              note: 'å‡ºç™¼ 21:10ï¼ˆHKGï¼‰ï¼Œé£›è¡Œç´„ 1 å°æ™‚ 45 åˆ†ï¼Œ22:55 æŠµé”å°åŒ—æ¡ƒåœ’ (TPE)ã€‚æ•´æ®µæ—…ç¨‹ç¸½è€—æ™‚ç´„ 16 å°æ™‚ 05 åˆ†ï¼ˆå«è½‰æ©Ÿï¼‰ã€‚',
              lat: 22.3080,
              lng: 113.9185,
              weather: null,
            },
            // æŠµé”å°åŒ—ï¼ˆå‚™è¨»ä¿ç•™ï¼‰
            {
              id: 1304,
              time: '22:55',
              place: 'æŠµé”å°åŒ—æ¡ƒåœ’æ©Ÿå ´ (TPE)',
              type: 'æŠµé”',
              note: 'ä¸‹æ©Ÿå¾Œé€šé—œèˆ‡é ˜è¡Œæï¼ŒçµæŸåŒ—æ­æ—…ç¨‹ã€‚è¨˜å¾—æª¢æŸ¥è¡Œæèˆ‡é€€ç¨…å–®æ“šã€‚',
              lat: 25.0803,
              lng: 121.2327,
              weather: null,
            },
          ],
        },
      ],

      selectedDayIndex: 0,

      // è²»ç”¨ç›¸é—œ
      numberOfPeople: 2,
      newExpense: { category: 'æ™¯é»', desc: '', amount: 0 },

      // åœ°åœ–ç›¸é—œ
      map: null,
      markersLayer: null, // æ™®é€šåœ°é»æ¨™è¨˜
      routeLayer: null,   // polyline èˆ‡é †åºæ¨™è¨˜
      showRoute: false,
    };
  },

  computed: {
    currentDay() {
      return this.days[this.selectedDayIndex];
    },

    // å…¨éƒ¨æ—¥æœŸåˆè¨ˆï¼šæ¯äºº
    totalPerPersonAcrossDays() {
      return this.days.reduce((sum, day) => {
        const daySum = (day.expenses || []).reduce((s, e) => s + (Number(e.amount) || 0), 0);
        return sum + daySum;
      }, 0);
    },

    // å…¨éƒ¨æ—¥æœŸåˆè¨ˆï¼šæ‰€æœ‰äºº
    totalAllPeopleAcrossDays() {
      return this.totalPerPersonAcrossDays * (this.numberOfPeople || 1);
    },
  },

  // ç›£è½ currentTabï¼Œç•¶åˆ‡æ›åˆ° åœ°åœ– æ™‚ç¢ºä¿åœ°åœ–åˆå§‹åŒ–èˆ‡é‡æ–°è¨ˆç®—å°ºå¯¸
  watch: {
    currentTab(newVal) {
      if (newVal === 'åœ°åœ–') {
        this.$nextTick(() => {
          if (!this.map) {
            this.initMap();
          } else {
            try { this.map.invalidateSize(); } catch (e) {}
          }
          this.focusTodayOnMap();
        });
      }
    }
  },

  methods: {
    selectDay(index) {
      this.selectedDayIndex = index;
      if (this.currentTab === 'åœ°åœ–') {
        this.$nextTick(() => this.focusTodayOnMap());
      }
    },

    toggleRoute() {
      this.showRoute = !this.showRoute;
      // é‡æ–°ç¹ªè£½åœ°åœ–å…§å®¹ï¼ˆæœƒæ ¹æ“š showRoute æ±ºå®šæ˜¯å¦ç•« polyline + é †åºæ¨™è¨˜ï¼‰
      this.$nextTick(() => this.focusTodayOnMap());
    },

    addDay() {
      // ä¿ç•™ä½†ä¸å•Ÿç”¨æ–°å¢æ—¥æœŸåŠŸèƒ½
      alert('æ­¤ç‰ˆæœ¬ç‚ºå›ºå®šè¡Œç¨‹å±•ç¤ºç‰ˆï¼Œå¦‚éœ€æ–°å¢è«‹è¯çµ¡ç®¡ç†å“¡');
    },

    async fetchWeatherForItem(item) {
      if (!item.lat || !item.lng) {
        item.weather = { loading: false, temp: 'â€”', summary: 'ç„¡åº§æ¨™è³‡æ–™' };
        return;
      }

      item.weather = { loading: true };

      try {
        // Open-Meteo å…é‡‘é‘°å³æ™‚å¤©æ°£ API [web:40]
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${item.lat}&longitude=${item.lng}&current=temperature_2m,weather_code`;

        const res = await fetch(url);
        const data = await res.json();

        const temp = data?.current?.temperature_2m ?? null;
        const code = data?.current?.weather_code ?? null;

        const summary = this.mapWeatherCodeToText(code);

        item.weather = {
          loading: false,
          temp: temp !== null ? temp.toFixed(1) : 'â€”',
          summary: summary,
        };
      } catch (e) {
        item.weather = {
          loading: false,
          temp: 'â€”',
          summary: 'å¤©æ°£è®€å–å¤±æ•—',
        };
      }
    },

    mapWeatherCodeToText(code) {
      if (code === null || code === undefined) return 'æœªçŸ¥å¤©æ°£';
      if (code === 0) return 'æ™´æœ—';
      if ([1, 2, 3].includes(code)) return 'å¤šé›²';
      if ([45, 48].includes(code)) return 'éœ§';
      if ([51, 53, 55].includes(code)) return 'æ¯›æ¯›é›¨';
      if ([61, 63, 65].includes(code)) return 'ä¸‹é›¨';
      if ([71, 73, 75, 77].includes(code)) return 'ä¸‹é›ª';
      if ([80, 81, 82].includes(code)) return 'é™£é›¨';
      if ([95, 96, 99].includes(code)) return 'é›·é›¨';
      return 'å¤©æ°£å¤šè®Š';
    },

    initMap() {
      // è‹¥å·²å­˜åœ¨ map å‰‡ç•¥é
      if (this.map) return;

      this.map = L.map('map').setView([64.1466, -21.9426], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap',
      }).addTo(this.map);

      this.markersLayer = L.layerGroup().addTo(this.map);
      this.routeLayer = L.layerGroup().addTo(this.map);

      // é¡¯ç¤ºç›®å‰ä½ç½®ï¼ˆå¦‚æœå…è¨±ï¼‰
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            L.circleMarker([latitude, longitude], {
              radius: 8,
              color: '#f97316',
              fillColor: '#f97316',
              fillOpacity: 0.9,
            })
              .bindPopup('ä½ ç¾åœ¨çš„ä½ç½®')
              .addTo(this.map);
          },
          () => {},
          { enableHighAccuracy: true, timeout: 5000 }
        );
      }

      // è‹¥å®¹å™¨åˆå§‹ç‚º hiddenï¼ˆv-show ä½†æ¨£å¼å¯èƒ½ä»å½±éŸ¿ï¼‰ï¼Œå»¶é²å‘¼å« invalidateSize å¯é¿å…é¡¯ç¤ºå•é¡Œ
      setTimeout(() => {
        try { this.map.invalidateSize(); } catch (e) {}
      }, 200);
    },

    focusTodayOnMap() {
      if (!this.map || !this.markersLayer || !this.routeLayer) return;

      // æ¸…é™¤æ‰€æœ‰åœ–å±¤ï¼ˆä¿ç•™ base tilesï¼‰
      this.markersLayer.clearLayers();
      this.routeLayer.clearLayers();

      const items = this.currentDay.items.filter((i) => i.place && i.lat && i.lng);

      // ä¸€èˆ¬æ¨™è¨˜ï¼ˆå¯é»é–‹çœ‹è©³æƒ…ï¼‰
      items.forEach((item, idx) => {
        const marker = L.marker([item.lat, item.lng]).addTo(this.markersLayer);
        marker.bindPopup(
          `<div class="text-xs">
            <strong>${item.place}</strong><br>
            <span class="text-blue-600">${item.time}</span><br>
            ${item.note ? item.note.substring(0, 80) + '...' : ''}
          </div>`
        );
      });

      // å¦‚æœå•Ÿç”¨è·¯ç·šï¼Œç¹ªè£½ polyline ä¸¦åœ¨æ¯å€‹é»ä¸ŠåŠ é †åºæ•¸å­—æ¨™è¨˜
      if (this.showRoute && items.length > 0) {
        const latlngs = items.map(i => [i.lat, i.lng]);

        // polyline
        const poly = L.polyline(latlngs, { color: '#f97316', weight: 4, opacity: 0.9 }).addTo(this.routeLayer);

        // é †åºæ¨™è¨˜ï¼ˆä½¿ç”¨ divIconï¼‰
        items.forEach((item, idx) => {
          const order = idx + 1;
          const divIcon = L.divIcon({
            className: '',
            html: `<div class="route-num">${order}</div>`,
            iconSize: [22, 22],
            iconAnchor: [11, 11],
            popupAnchor: [0, -12],
          });
          const numMarker = L.marker([item.lat, item.lng], { icon: divIcon }).addTo(this.routeLayer);
          numMarker.bindPopup(
            `<div class="text-xs">
              <strong>#${order} ${item.place}</strong><br>
              <span class="text-blue-600">${item.time}</span>
            </div>`
          );
        });

        // adjust view to fit route
        try {
          this.map.fitBounds(poly.getBounds(), { padding: [20, 20] });
        } catch (e) {
          // ignore if poly has invalid bounds
        }
      } else {
        // è‹¥æ²’è·¯ç·šï¼Œæ ¹æ“šä¸€èˆ¬æ¨™è¨˜èª¿æ•´è¦–çª—
        if (items.length > 0) {
          const group = new L.featureGroup(items.map(i => L.marker([i.lat, i.lng])));
          this.map.fitBounds(group.getBounds(), { padding: [20, 20] });
        }
      }
    },

    // ---------------- è²»ç”¨ç®¡ç†æ–¹æ³• ----------------
    ensureExpensesInitialized() {
      this.days.forEach(d => {
        if (!Array.isArray(d.expenses)) d.expenses = [];
      });
    },

    addExpense(day) {
      const e = {
        id: Date.now() + Math.floor(Math.random() * 1000),
        category: this.newExpense.category || 'å…¶ä»–',
        desc: this.newExpense.desc || '',
        amount: Number(this.newExpense.amount) || 0,
      };
      day.expenses.push(e);
      this.newExpense.desc = '';
      this.newExpense.amount = 0;
      this.newExpense.category = 'æ™¯é»';
    },

    removeExpense(day, expenseId) {
      day.expenses = (day.expenses || []).filter(e => e.id !== expenseId);
    },

    dayCategoryTotals(day) {
      const categories = {};
      (day.expenses || []).forEach(e => {
        const cat = e.category || 'å…¶ä»–';
        if (!categories[cat]) categories[cat] = { perPerson: 0, total: 0 };
        const per = Number(e.amount) || 0;
        categories[cat].perPerson += per;
        categories[cat].total = categories[cat].perPerson * (this.numberOfPeople || 1);
      });
      return categories;
    },

    dayTotalPerPerson(day) {
      return (day.expenses || []).reduce((s, e) => s + (Number(e.amount) || 0), 0);
    },

    dayTotalAll(day) {
      return this.dayTotalPerPerson(day) * (this.numberOfPeople || 1);
    },

    formatCurrency(value) {
      const v = Number(value) || 0;
      return Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(v);
    },
  },

  mounted() {
    this.$nextTick(() => {
      // ç¢ºä¿æ¯å€‹ day æœ‰ expenses é™£åˆ—
      this.ensureExpensesInitialized();

      // åˆå§‹åŒ–åœ°åœ–ï¼ˆv-show å·²ç¢ºä¿ #map åœ¨ DOMï¼‰ï¼Œä¸¦å˜—è©¦ focus
      this.initMap();
      if (this.currentTab === 'åœ°åœ–') {
        this.focusTodayOnMap();
      }
    });
  },
}).mount('#app');
</script>
</body>
</html>
